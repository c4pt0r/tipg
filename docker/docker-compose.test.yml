version: '3.8'

services:
  pd:
    image: pingcap/pd:v8.1.0
    ports:
      - "2379:2379"
    command:
      - --name=pd
      - --client-urls=http://0.0.0.0:2379
      - --peer-urls=http://0.0.0.0:2380
      - --advertise-client-urls=http://pd:2379
      - --advertise-peer-urls=http://pd:2380
      - --initial-cluster=pd=http://pd:2380
      - --data-dir=/data/pd
    volumes:
      - pd_data:/data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:2379/health"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks:
      - pgtikv

  tikv:
    image: pingcap/tikv:v8.1.0
    ports:
      - "20160:20160"
    command:
      - --addr=0.0.0.0:20160
      - --advertise-addr=tikv:20160
      - --pd=pd:2379
      - --data-dir=/data/tikv
      - --config=/etc/tikv/tikv.toml
    volumes:
      - tikv_data:/data
      - ./tikv.toml:/etc/tikv/tikv.toml:ro
    depends_on:
      pd:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:20180/status"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    networks:
      - pgtikv

  pg-tikv:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    ports:
      - "5434:5433"
    environment:
      - PD_ENDPOINTS=pd:2379
      - PG_PORT=5433
      - PG_PASSWORD=postgres
      - RUST_LOG=info
    depends_on:
      tikv:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5433", "-U", "postgres"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - pgtikv

  sql-test:
    image: postgres:16-bookworm
    depends_on:
      pg-tikv:
        condition: service_healthy
    environment:
      - PGHOST=pg-tikv
      - PGPORT=5433
      - PGUSER=postgres
      - PGPASSWORD=postgres
      - PGDATABASE=postgres
    volumes:
      - ../examples:/examples:ro
      - ../tests:/tests:ro
    entrypoint: []
    command: >
      bash -c "
        echo '=== pg-tikv SQL Test Suite ==='
        echo ''
        echo '>>> Testing connection...'
        psql -c 'SELECT version()' && echo 'Connection: OK' || exit 1
        echo ''
        echo '>>> Running fancy demo...'
        psql -f /examples/fancy_demo.sql
        echo ''
        echo '>>> Running basic tests...'
        psql -f /tests/01_ddl_basic.sql
        psql -f /tests/02_dml_crud.sql
        echo ''
        echo '=== SQL tests passed! ==='
      "
    networks:
      - pgtikv

  orm-test:
    image: node:20-bookworm
    depends_on:
      pg-tikv:
        condition: service_healthy
    environment:
      - PG_HOST=pg-tikv
      - PG_PORT=5433
      - PG_USER=postgres
      - PG_PASSWORD=postgres
      - PG_DATABASE=postgres
    volumes:
      - ../orm-tests:/app
    working_dir: /app
    entrypoint: []
    command: >
      bash -c "
        echo '=== pg-tikv ORM Test Suite ==='
        echo ''
        echo '>>> Installing dependencies...'
        npm install --silent
        echo ''
        echo '>>> Generating Prisma client...'
        npx prisma generate
        echo ''
        echo '>>> Running ORM tests...'
        npm test
        echo ''
        echo '=== ORM tests completed! ==='
      "
    networks:
      - pgtikv

  test-all:
    image: node:20-bookworm
    depends_on:
      pg-tikv:
        condition: service_healthy
    environment:
      - PG_HOST=pg-tikv
      - PGHOST=pg-tikv
      - PG_PORT=5433
      - PGPORT=5433
      - PG_USER=postgres
      - PGUSER=postgres
      - PG_PASSWORD=postgres
      - PGPASSWORD=postgres
      - PG_DATABASE=postgres
      - PGDATABASE=postgres
    volumes:
      - ../examples:/examples:ro
      - ../tests:/tests:ro
      - ../orm-tests:/orm-tests
    working_dir: /
    entrypoint: []
    command: >
      bash -c "
        echo '========================================='
        echo '  pg-tikv Complete Test Suite'
        echo '========================================='
        echo ''
        
        apt-get update -qq && apt-get install -y -qq postgresql-client > /dev/null 2>&1
        
        echo '>>> [1/3] Testing connection...'
        psql -c 'SELECT 1' > /dev/null && echo '    Connection: OK' || exit 1
        echo ''
        
        echo '>>> [2/3] Running SQL tests...'
        psql -f /examples/fancy_demo.sql > /dev/null 2>&1 && echo '    fancy_demo.sql: OK' || echo '    fancy_demo.sql: FAILED'
        psql -f /tests/01_ddl_basic.sql > /dev/null 2>&1 && echo '    01_ddl_basic.sql: OK' || echo '    01_ddl_basic.sql: FAILED'
        psql -f /tests/02_dml_crud.sql > /dev/null 2>&1 && echo '    02_dml_crud.sql: OK' || echo '    02_dml_crud.sql: FAILED'
        echo ''
        
        echo '>>> [3/3] Running ORM tests...'
        cd /orm-tests
        npm install --silent 2>/dev/null
        npx prisma generate 2>/dev/null
        npm test 2>&1 | tail -20
        echo ''
        
        echo '========================================='
        echo '  All tests completed!'
        echo '========================================='
      "
    networks:
      - pgtikv

networks:
  pgtikv:
    driver: bridge

volumes:
  pd_data:
  tikv_data:
